<div class="product-categories-page">
    <!-- 페이지 헤더 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <div class="d-flex align-items-center gap-2 mb-2">
                <a href="#" @click.prevent="navigateTo('/commerce/products')" class="text-muted">
                    ← 상품 목록
                </a>
            </div>
            <h4 class="mb-1">상품 카테고리 관리</h4>
            <p class="text-muted mb-0">상품 카테고리를 생성하고 관리합니다</p>
        </div>
        <button class="btn btn-primary" @click="openAddModal(null)">
            <span class="me-1">➕</span> 대분류 추가
        </button>
    </div>

    <!-- 카테고리 트리 -->
    <div class="card border-0 shadow-sm">
        <div class="card-body p-0">
            <div v-if="categories.length === 0" class="text-center text-muted py-5">
                <div class="fs-1 mb-3">📁</div>
                <div>등록된 카테고리가 없습니다</div>
            </div>
            <div v-else class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 50%;">카테고리명</th>
                            <th class="text-center">상품 수</th>
                            <th class="text-center">순서</th>
                            <th class="text-center">표시</th>
                            <th style="width: 200px;">작업</th>
                        </tr>
                    </thead>
                    <tbody>
                        <template v-for="category in sortedCategories" :key="category.id">
                            <!-- 대분류 -->
                            <tr v-if="!category.parentId">
                                <td>
                                    <div class="d-flex align-items-center">
                                        <button
                                            class="btn btn-sm btn-link text-muted p-0 me-2"
                                            @click="toggleExpand(category.id)"
                                            v-if="getChildren(category.id).length > 0"
                                        >
                                            <span v-if="expandedIds.includes(category.id)">▼</span>
                                            <span v-else>▶</span>
                                        </button>
                                        <span v-else class="me-4"></span>
                                        <strong>{{ category.name }}</strong>
                                    </div>
                                </td>
                                <td class="text-center">{{ category.productCount || 0 }}</td>
                                <td class="text-center">
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-secondary" @click="moveCategory(category, 'up')" :disabled="isFirst(category)">↑</button>
                                        <button class="btn btn-outline-secondary" @click="moveCategory(category, 'down')" :disabled="isLast(category)">↓</button>
                                    </div>
                                </td>
                                <td class="text-center">
                                    <div class="form-check form-switch d-inline-block">
                                        <input class="form-check-input" type="checkbox" v-model="category.isVisible" @change="updateCategory(category)">
                                    </div>
                                </td>
                                <td>
                                    <button class="btn btn-sm btn-outline-primary me-1" @click="openAddModal(category.id)">
                                        <span class="me-1">➕</span> 하위 추가
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary me-1" @click="openEditModal(category)">수정</button>
                                    <button class="btn btn-sm btn-outline-danger" @click="deleteCategory(category)">삭제</button>
                                </td>
                            </tr>

                            <!-- 중분류 (하위 카테고리) -->
                            <template v-if="expandedIds.includes(category.id)">
                                <tr v-for="child in getChildren(category.id)" :key="child.id" class="table-secondary">
                                    <td>
                                        <div class="d-flex align-items-center ps-5">
                                            <span class="me-2 text-muted">→</span>
                                            {{ child.name }}
                                        </div>
                                    </td>
                                    <td class="text-center">{{ child.productCount || 0 }}</td>
                                    <td class="text-center">
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-secondary" @click="moveCategory(child, 'up')" :disabled="isFirst(child)">↑</button>
                                            <button class="btn btn-outline-secondary" @click="moveCategory(child, 'down')" :disabled="isLast(child)">↓</button>
                                        </div>
                                    </td>
                                    <td class="text-center">
                                        <div class="form-check form-switch d-inline-block">
                                            <input class="form-check-input" type="checkbox" v-model="child.isVisible" @change="updateCategory(child)">
                                        </div>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-secondary me-1" @click="openEditModal(child)">수정</button>
                                        <button class="btn btn-sm btn-outline-danger" @click="deleteCategory(child)">삭제</button>
                                    </td>
                                </tr>
                            </template>
                        </template>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 카테고리 추가/수정 모달 -->
    <div v-if="showModal" class="modal d-block" tabindex="-1" style="background: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">{{ editingCategory ? '카테고리 수정' : '카테고리 추가' }}</h5>
                    <button type="button" class="btn-close" @click="showModal = false"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3" v-if="modalParentId">
                        <label class="form-label">상위 카테고리</label>
                        <input type="text" class="form-control" :value="getParentName(modalParentId)" disabled>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">카테고리명 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" v-model="categoryForm.name" placeholder="카테고리명을 입력하세요">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">설명</label>
                        <textarea class="form-control" rows="3" v-model="categoryForm.description" placeholder="카테고리에 대한 설명을 입력하세요 (선택사항)"></textarea>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" v-model="categoryForm.isVisible" id="isVisible">
                            <label class="form-check-label" for="isVisible">
                                표시
                            </label>
                        </div>
                        <div class="form-text">체크 해제 시 사용자 페이지에서 숨겨집니다</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @click="showModal = false">취소</button>
                    <button type="button" class="btn btn-primary" @click="saveCategory">
                        {{ editingCategory ? '수정' : '추가' }}
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

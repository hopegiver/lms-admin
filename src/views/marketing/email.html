<div class="email-sending-page">
    <!-- í˜ì´ì§€ í—¤ë” -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h4 class="mb-1">ì´ë©”ì¼ ë°œì†¡</h4>
            <p class="text-muted mb-0">ì´ë©”ì¼ ìº í˜ì¸ì„ ìƒì„±í•˜ê³  ë°œì†¡í•©ë‹ˆë‹¤</p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary" @click="saveDraft">
                <span class="me-1">ğŸ’¾</span> ì„ì‹œì €ì¥
            </button>
            <button class="btn btn-outline-secondary" @click="navigateTo('/marketing/campaigns')">
                ì·¨ì†Œ
            </button>
        </div>
    </div>

    <!-- ì§„í–‰ ë‹¨ê³„ -->
    <div class="card border-0 shadow-sm mb-4">
        <div class="card-body">
            <div class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center flex-grow-1">
                    <div class="step-indicator" :class="{ active: step >= 1, completed: step > 1 }">
                        <div class="step-number">1</div>
                        <div class="step-label">ê¸°ë³¸ ì •ë³´</div>
                    </div>
                    <div class="step-divider" :class="{ active: step > 1 }"></div>
                    <div class="step-indicator" :class="{ active: step >= 2, completed: step > 2 }">
                        <div class="step-number">2</div>
                        <div class="step-label">ë‚´ìš© ì‘ì„±</div>
                    </div>
                    <div class="step-divider" :class="{ active: step > 2 }"></div>
                    <div class="step-indicator" :class="{ active: step >= 3 }">
                        <div class="step-number">3</div>
                        <div class="step-label">í™•ì¸ ë° ë°œì†¡</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Step 1: ê¸°ë³¸ ì •ë³´ -->
    <div v-if="step === 1" class="row">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white py-3">
                    <h6 class="mb-0">ë°œì‹ ì ì •ë³´</h6>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label">ìº í˜ì¸ëª… <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" v-model="emailForm.campaignName"
                                   placeholder="ì˜ˆ: ì‹ ê·œ ê°•ì¢Œ ì¶œì‹œ ì•ˆë‚´">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">ë°œì‹ ìëª… <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" v-model="emailForm.senderName"
                                   placeholder="ì˜ˆ: LMS ìš´ì˜íŒ€">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">ë°œì‹  ì´ë©”ì¼ <span class="text-danger">*</span></label>
                            <input type="email" class="form-control" v-model="emailForm.senderEmail"
                                   placeholder="noreply@example.com">
                        </div>
                        <div class="col-12">
                            <label class="form-label">íšŒì‹  ì´ë©”ì¼</label>
                            <input type="email" class="form-control" v-model="emailForm.replyTo"
                                   placeholder="support@example.com">
                            <div class="form-text">ìˆ˜ì‹ ìê°€ ë‹µì¥í•  ë•Œ ì‚¬ìš©ë  ì´ë©”ì¼ ì£¼ì†Œ</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white py-3">
                    <h6 class="mb-0">ìˆ˜ì‹  ëŒ€ìƒ</h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" v-model="emailForm.targetType"
                                   value="all" id="targetAll">
                            <label class="form-check-label" for="targetAll">
                                ì „ì²´ ë°œì†¡ (5,230ëª…)
                            </label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" v-model="emailForm.targetType"
                                   value="groups" id="targetGroups">
                            <label class="form-check-label" for="targetGroups">
                                ê·¸ë£¹ ì„ íƒ
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" v-model="emailForm.targetType"
                                   value="custom" id="targetCustom">
                            <label class="form-check-label" for="targetCustom">
                                ì§ì ‘ ì„ íƒ
                            </label>
                        </div>
                    </div>

                    <div v-if="emailForm.targetType === 'groups'" class="mt-3">
                        <label class="form-label">ìˆ˜ì‹  ê·¸ë£¹ ì„ íƒ</label>
                        <div v-for="group in availableGroups" :key="group.id" class="form-check mb-2">
                            <input class="form-check-input" type="checkbox"
                                   :value="group.id" v-model="emailForm.targetGroups"
                                   :id="'group-' + group.id">
                            <label class="form-check-label" :for="'group-' + group.id">
                                {{ group.name }} <span class="text-muted">({{ group.count.toLocaleString() }}ëª…)</span>
                            </label>
                        </div>
                    </div>

                    <div v-if="emailForm.targetType === 'custom'" class="mt-3">
                        <label class="form-label">ìˆ˜ì‹ ì ì§ì ‘ ì…ë ¥</label>
                        <textarea class="form-control" rows="4"
                                  placeholder="ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì‰¼í‘œ ë˜ëŠ” ì¤„ë°”ê¿ˆìœ¼ë¡œ êµ¬ë¶„)"></textarea>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card border-0 shadow-sm sticky-top" style="top: 80px;">
                <div class="card-header bg-white py-3">
                    <h6 class="mb-0">ë°œì†¡ ìš”ì•½</h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="text-muted small mb-1">ì˜ˆìƒ ë°œì†¡ ìˆ˜</div>
                        <div class="h4 text-primary">{{ targetCount.toLocaleString() }}ëª…</div>
                    </div>
                    <div class="mb-3">
                        <div class="text-muted small mb-1">ì˜ˆìƒ ë¹„ìš©</div>
                        <div class="h5">â‚©{{ estimatedCost.toLocaleString() }}</div>
                    </div>
                    <hr>
                    <button class="btn btn-primary w-100" @click="nextStep" :disabled="!canProceedToStep2">
                        ë‹¤ìŒ ë‹¨ê³„
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Step 2: ë‚´ìš© ì‘ì„± -->
    <div v-if="step === 2" class="row">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white py-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">ì´ë©”ì¼ ë‚´ìš©</h6>
                        <button class="btn btn-sm btn-outline-secondary" @click="togglePreview">
                            {{ previewMode ? 'í¸ì§‘ ëª¨ë“œ' : 'ë¯¸ë¦¬ë³´ê¸°' }}
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div v-if="!previewMode">
                        <div class="mb-3">
                            <label class="form-label">ì œëª© <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" v-model="emailForm.subject"
                                   placeholder="ì´ë©”ì¼ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ë‚´ìš© <span class="text-danger">*</span></label>
                            <textarea class="form-control" rows="15" v-model="emailForm.content"
                                      placeholder="ì´ë©”ì¼ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                        </div>
                        <div class="d-flex gap-2 flex-wrap">
                            <button class="btn btn-sm btn-outline-secondary" @click="insertVariable('ì´ë¦„')">ì´ë¦„ ì‚½ì…</button>
                            <button class="btn btn-sm btn-outline-secondary" @click="insertVariable('ì´ë©”ì¼')">ì´ë©”ì¼ ì‚½ì…</button>
                            <button class="btn btn-sm btn-outline-secondary" @click="insertVariable('ê°•ì¢Œëª…')">ê°•ì¢Œëª… ì‚½ì…</button>
                            <button class="btn btn-sm btn-outline-secondary" @click="insertVariable('ì§„ë„ìœ¨')">ì§„ë„ìœ¨ ì‚½ì…</button>
                        </div>
                    </div>
                    <div v-else class="email-preview bg-light p-4 rounded">
                        <div class="border bg-white p-4 rounded">
                            <h5 class="border-bottom pb-3 mb-3">{{ emailForm.subject || '(ì œëª© ì—†ìŒ)' }}</h5>
                            <div style="white-space: pre-wrap;">{{ emailForm.content || '(ë‚´ìš© ì—†ìŒ)' }}</div>
                            <hr class="my-4">
                            <div class="text-muted small">
                                ë°œì‹ : {{ emailForm.senderName }} &lt;{{ emailForm.senderEmail }}&gt;
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card border-0 shadow-sm sticky-top" style="top: 80px;">
                <div class="card-header bg-white py-3">
                    <h6 class="mb-0">ì‘ì„± ë„ì›€ë§</h6>
                </div>
                <div class="card-body">
                    <p class="small text-muted mb-2">ê°œì¸í™” ë³€ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ ë§ì¶¤ ë©”ì‹œì§€ë¥¼ ì „ì†¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                    <ul class="small text-muted mb-3">
                        <li>{{ì´ë¦„}} - ìˆ˜ì‹ ì ì´ë¦„</li>
                        <li>{{ì´ë©”ì¼}} - ìˆ˜ì‹ ì ì´ë©”ì¼</li>
                        <li>{{ê°•ì¢Œëª…}} - ìˆ˜ê°• ì¤‘ì¸ ê°•ì¢Œ</li>
                        <li>{{ì§„ë„ìœ¨}} - í•™ìŠµ ì§„ë„</li>
                    </ul>
                    <hr>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-secondary" @click="prevStep">ì´ì „</button>
                        <button class="btn btn-primary flex-grow-1" @click="nextStep" :disabled="!canProceedToStep3">
                            ë‹¤ìŒ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Step 3: í™•ì¸ ë° ë°œì†¡ -->
    <div v-if="step === 3" class="row">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-white py-3">
                    <h6 class="mb-0">ë°œì†¡ ì •ë³´ í™•ì¸</h6>
                </div>
                <div class="card-body">
                    <table class="table table-borderless">
                        <tr>
                            <th style="width: 150px;">ìº í˜ì¸ëª…</th>
                            <td>{{ emailForm.campaignName }}</td>
                        </tr>
                        <tr>
                            <th>ë°œì‹ ì</th>
                            <td>{{ emailForm.senderName }} &lt;{{ emailForm.senderEmail }}&gt;</td>
                        </tr>
                        <tr>
                            <th>ìˆ˜ì‹  ëŒ€ìƒ</th>
                            <td>
                                <span v-if="emailForm.targetType === 'all'">ì „ì²´ ë°œì†¡</span>
                                <span v-else-if="emailForm.targetType === 'groups'">
                                    ì„ íƒí•œ ê·¸ë£¹: {{ emailForm.targetGroups.map(id => getGroupName(id)).join(', ') }}
                                </span>
                                <span v-else>ì§ì ‘ ì„ íƒ</span>
                                <span class="badge bg-primary ms-2">{{ targetCount.toLocaleString() }}ëª…</span>
                            </td>
                        </tr>
                        <tr>
                            <th>ì œëª©</th>
                            <td>{{ emailForm.subject }}</td>
                        </tr>
                    </table>
                </div>
            </div>

            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white py-3">
                    <h6 class="mb-0">ë°œì†¡ ì‹œê°„ ì„¤ì •</h6>
                </div>
                <div class="card-body">
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="radio" v-model="emailForm.scheduleType"
                               value="now" id="scheduleNow">
                        <label class="form-check-label" for="scheduleNow">
                            ì¦‰ì‹œ ë°œì†¡
                        </label>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="radio" v-model="emailForm.scheduleType"
                               value="schedule" id="scheduleTime">
                        <label class="form-check-label" for="scheduleTime">
                            ì˜ˆì•½ ë°œì†¡
                        </label>
                    </div>
                    <div v-if="emailForm.scheduleType === 'schedule'" class="row g-2 ms-4">
                        <div class="col-md-6">
                            <input type="date" class="form-control" v-model="emailForm.scheduleDate">
                        </div>
                        <div class="col-md-6">
                            <input type="time" class="form-control" v-model="emailForm.scheduleTime">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card border-0 shadow-sm sticky-top" style="top: 80px;">
                <div class="card-header bg-white py-3">
                    <h6 class="mb-0">ìµœì¢… í™•ì¸</h6>
                </div>
                <div class="card-body">
                    <div class="alert alert-info small mb-3">
                        ë°œì†¡ í›„ì—ëŠ” ì·¨ì†Œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ëª¨ë“  ì •ë³´ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.
                    </div>
                    <div class="mb-3">
                        <div class="text-muted small mb-1">ì´ ë°œì†¡ ìˆ˜</div>
                        <div class="h4 text-primary">{{ targetCount.toLocaleString() }}ëª…</div>
                    </div>
                    <div class="mb-4">
                        <div class="text-muted small mb-1">ì˜ˆìƒ ë¹„ìš©</div>
                        <div class="h5">â‚©{{ estimatedCost.toLocaleString() }}</div>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-secondary" @click="prevStep">ì´ì „</button>
                        <button class="btn btn-primary flex-grow-1" @click="sendEmail">
                            <span class="me-1">ğŸ“§</span> ë°œì†¡
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.step-indicator {
    display: flex;
    flex-direction: column;
    align-items: center;
    opacity: 0.5;
}
.step-indicator.active {
    opacity: 1;
}
.step-indicator.completed .step-number {
    background-color: #28a745;
    border-color: #28a745;
}
.step-number {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: 2px solid #dee2e6;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    background-color: white;
    margin-bottom: 8px;
}
.step-indicator.active .step-number {
    border-color: #0d6efd;
    color: #0d6efd;
}
.step-label {
    font-size: 14px;
    white-space: nowrap;
}
.step-divider {
    flex-grow: 1;
    height: 2px;
    background-color: #dee2e6;
    margin: 0 20px;
    align-self: flex-start;
    margin-top: 19px;
}
.step-divider.active {
    background-color: #0d6efd;
}
</style>

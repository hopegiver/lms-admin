<div class="sms-sending-page">
    <!-- 페이지 헤더 -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h4 class="mb-1">SMS 발송</h4>
            <p class="text-muted mb-0">개별 SMS/LMS를 빠르게 발송합니다</p>
        </div>
        <button class="btn btn-outline-secondary" @click="navigateTo('/marketing/campaigns')">
            뒤로 가기
        </button>
    </div>

    <div class="row">
        <!-- 왼쪽: 작성 영역 -->
        <div class="col-lg-7">
            <div class="card border-0 shadow-sm">
                <div class="card-body">
                    <!-- 발신 정보 -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0">발신 정보</h6>
                            <button type="button" class="btn btn-sm btn-outline-primary" @click="openNumberModal">
                                + 번호 추가
                            </button>
                        </div>
                        <div class="row g-3">
                            <div class="col-10">
                                <label class="form-label">발신번호</label>
                                <select class="form-select" v-model="smsForm.senderNumber">
                                    <option v-for="num in senderNumbers.filter(n => n.status === 'active')" :key="num.number" :value="num.number">
                                        {{ num.number }} - {{ num.name }}
                                    </option>
                                </select>
                            </div>
                            <div class="col-2">
                                <label class="form-label">&nbsp;</label>
                                <button type="button" class="btn btn-outline-danger w-100" @click="deleteSelectedNumber" :disabled="!smsForm.senderNumber">
                                    삭제
                                </button>
                            </div>
                        </div>
                    </div>

                    <hr>

                    <!-- 메시지 작성 -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 class="mb-0">메시지 작성</h6>
                            <span class="badge" :class="messageType === 'SMS' ? 'bg-success' : 'bg-primary'">
                                {{ messageType }}
                            </span>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">제목 <span v-if="messageType === 'LMS'" class="text-danger">*</span></label>
                            <input type="text" class="form-control" v-model="smsForm.title"
                                   :placeholder="messageType === 'LMS' ? 'LMS 제목을 입력하세요 (필수)' : '제목을 입력하세요 (선택사항)'">
                        </div>

                        <div class="mb-2">
                            <label class="form-label">본문 <span class="text-danger">*</span></label>
                            <div class="btn-group btn-group-sm mb-2">
                                <button type="button" class="btn btn-outline-secondary" @click="insertVariable('이름')">
                                    {{이름}}
                                </button>
                                <button type="button" class="btn btn-outline-secondary" @click="insertVariable('강좌명')">
                                    {{강좌명}}
                                </button>
                                <button type="button" class="btn btn-outline-secondary" @click="insertVariable('진도율')">
                                    {{진도율}}
                                </button>
                                <button type="button" class="btn btn-outline-secondary" @click="insertVariable('남은일수')">
                                    {{남은일수}}
                                </button>
                            </div>
                        </div>
                        <div class="mb-2">
                            <textarea class="form-control" rows="8" v-model="smsForm.message"
                                      :placeholder="'메시지를 입력하세요. ' + (messageType === 'SMS' ? '90 byte 초과 시 LMS로 발송됩니다.' : 'LMS는 최대 2000byte까지 입력 가능합니다.')"></textarea>
                        </div>
                        <div class="d-flex justify-content-between align-items-center small text-muted">
                            <span>{{ messageLength }}자 / {{ messageByte }} byte</span>
                            <span>최대: {{ maxLength }} byte</span>
                        </div>
                        <div v-if="messageByte > maxLength" class="alert alert-warning small mt-2 mb-0">
                            메시지 길이가 {{ messageType }} 최대 byte를 초과했습니다.
                        </div>
                    </div>

                    <hr>

                    <!-- 수신 대상 -->
                    <div class="mb-4">
                        <h6 class="mb-3">수신 대상 <span class="text-danger">*</span></h6>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" v-model="smsForm.targetType"
                                   value="all" id="targetAll">
                            <label class="form-check-label" for="targetAll">
                                전체 발송 (5,230명)
                            </label>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="radio" v-model="smsForm.targetType"
                                   value="groups" id="targetGroups">
                            <label class="form-check-label" for="targetGroups">
                                그룹 선택
                            </label>
                        </div>

                        <div v-if="smsForm.targetType === 'groups'" class="ms-4">
                            <div v-for="group in availableGroups" :key="group.id" class="form-check mb-2">
                                <input class="form-check-input" type="checkbox"
                                       :value="group.id" v-model="smsForm.targetGroups"
                                       :id="'group-' + group.id">
                                <label class="form-check-label" :for="'group-' + group.id">
                                    {{ group.name }} <span class="text-muted">({{ group.count.toLocaleString() }}명)</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <hr>

                    <!-- 발송 시간 -->
                    <div class="mb-0">
                        <h6 class="mb-3">발송 시간</h6>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="radio" v-model="smsForm.scheduleType"
                                   value="now" id="scheduleNow">
                            <label class="form-check-label" for="scheduleNow">
                                즉시 발송
                            </label>
                        </div>
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="radio" v-model="smsForm.scheduleType"
                                   value="schedule" id="scheduleTime">
                            <label class="form-check-label" for="scheduleTime">
                                예약 발송
                            </label>
                        </div>
                        <div v-if="smsForm.scheduleType === 'schedule'" class="row g-2 ms-4">
                            <div class="col-md-6">
                                <input type="date" class="form-control" v-model="smsForm.scheduleDate">
                            </div>
                            <div class="col-md-6">
                                <input type="time" class="form-control" v-model="smsForm.scheduleTime">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 오른쪽: 미리보기 영역 -->
        <div class="col-lg-5">
            <div class="card border-0 shadow-sm sticky-top" style="top: 80px;">
                <div class="card-header bg-white py-3">
                    <h6 class="mb-0">미리보기</h6>
                </div>
                <div class="card-body">
                    <!-- SMS 미리보기 -->
                    <div class="border rounded p-3 mb-4 bg-light" style="min-height: 300px;">
                        <div class="mb-3 pb-3 border-bottom">
                            <div class="small text-muted mb-1">발신번호</div>
                            <div class="fw-medium">{{ smsForm.senderNumber }}</div>
                        </div>
                        <div class="mb-3 pb-3 border-bottom">
                            <div class="small text-muted mb-1">메시지 유형</div>
                            <span class="badge" :class="messageType === 'SMS' ? 'bg-success' : 'bg-primary'">
                                {{ messageType }}
                            </span>
                        </div>
                        <div style="white-space: pre-wrap; line-height: 1.6; font-family: monospace;">
                            {{ previewMessage || '(메시지를 입력하세요)' }}
                        </div>
                    </div>

                    <hr>

                    <!-- 발송 정보 -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted small">발송 대상</span>
                            <span class="fw-bold text-primary fs-5">{{ targetCount.toLocaleString() }}명</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted small">단가</span>
                            <span class="fw-medium">₩{{ (messageType === 'LMS' ? 30 : 20).toLocaleString() }}/건</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted small">예상 비용</span>
                            <span class="fw-medium">₩{{ estimatedCost.toLocaleString() }}</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-muted small">발송 방식</span>
                            <span class="fw-medium">
                                <span v-if="smsForm.scheduleType === 'now'">즉시 발송</span>
                                <span v-else-if="smsForm.scheduleDate && smsForm.scheduleTime">
                                    {{ smsForm.scheduleDate }} {{ smsForm.scheduleTime }}
                                </span>
                                <span v-else class="text-muted">(미설정)</span>
                            </span>
                        </div>
                    </div>

                    <div class="alert alert-info small mb-3">
                        발송 후 발송 내역에서 결과를 확인할 수 있습니다.
                    </div>

                    <button class="btn btn-primary w-100 btn-lg" @click="sendSms">
                        <span class="me-1">💬</span> SMS 발송
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 발신번호 추가 모달 -->
    <div v-if="showNumberModal" class="modal d-block" tabindex="-1" style="background: rgba(0,0,0,0.5);">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">발신번호 추가</h5>
                    <button type="button" class="btn-close" @click="closeNumberModal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-info small">
                        발신번호는 통신사 승인 후 사용 가능합니다. 승인은 1~2 영업일 소요됩니다.
                    </div>
                    <div class="mb-3">
                        <label class="form-label">발신번호 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" v-model="newNumber.number"
                               placeholder="예: 02-1234-5678 또는 1588-0000">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">번호 이름 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" v-model="newNumber.name"
                               placeholder="예: LMS 고객센터">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @click="closeNumberModal">취소</button>
                    <button type="button" class="btn btn-primary" @click="addNumber">등록</button>
                </div>
            </div>
        </div>
    </div>
</div>
